# Relatório de Pentest - MoMoney

**Data:** $(date)  
**Versão Testada:** Desenvolvimento  
**Metodologia:** OWASP Top 10 + Análise Estática de Código

---

## Resumo Executivo

Este relatório documenta os resultados de um teste de penetração realizado na aplicação MoMoney. Foram identificadas **15 vulnerabilidades** classificadas por severidade:

- **Crítica:** 3
- **Alta:** 5
- **Média:** 4
- **Baixa:** 3

---

## 1. Exposição de Dados Sensíveis

### VULN-001: Chave Supabase Exposta no Frontend [CRÍTICA]

**Severidade:** Crítica  
**CVSS Score:** 9.1 (Crítico)

**Descrição:**
A chave pública do Supabase (`SUPABASE_PUBLISHABLE_KEY`) está hardcoded no código fonte do frontend, exposta no arquivo `src/integrations/supabase/client.ts` linha 6.

**Evidência:**
```typescript
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
```

**Impacto:**
- A chave pode ser extraída do bundle JavaScript por qualquer pessoa
- Embora seja uma chave pública, sua exposição facilita ataques de enumeração
- Permite que atacantes identifiquem o projeto Supabase associado

**Recomendação:**
- Mover a chave para variáveis de ambiente
- Usar `import.meta.env.VITE_SUPABASE_ANON_KEY` no Vite
- Adicionar validação de origem no Supabase Dashboard

**Prioridade:** Crítica - Corrigir imediatamente

---

### VULN-002: Dados Sensíveis em localStorage [ALTA]

**Severidade:** Alta  
**CVSS Score:** 7.2 (Alto)

**Descrição:**
Tokens de sessão e preferências do usuário são armazenados em `localStorage`, que é vulnerável a ataques XSS.

**Evidência:**
- `src/integrations/supabase/client.ts` linha 13: `storage: localStorage`
- `src/hooks/useUserPreferences.tsx` linhas 43, 61, 87: Armazena preferências em localStorage

**Impacto:**
- Se um atacante conseguir executar XSS, pode roubar tokens de sessão
- Dados de preferências podem conter informações sensíveis

**Recomendação:**
- Considerar usar `sessionStorage` para dados temporários
- Implementar HttpOnly cookies para tokens (se possível)
- Adicionar sanitização adicional antes de armazenar dados

**Prioridade:** Alta - Corrigir em 1 semana

---

### VULN-003: Informações Sensíveis em Logs do Console [MÉDIA]

**Severidade:** Média  
**CVSS Score:** 5.3 (Médio)

**Descrição:**
Múltiplos `console.log`, `console.error` e `console.debug` podem expor informações sensíveis em produção.

**Evidência:**
- 105 ocorrências de `console.*` no código
- Exemplos: `src/hooks/useMFA.tsx` linha 73, `src/hooks/useUserPreferences.tsx` linha 103

**Impacto:**
- Informações podem ser visíveis no DevTools do navegador
- Logs podem conter IDs de usuário, erros detalhados, etc.

**Recomendação:**
- Remover ou desabilitar console.logs em produção
- Usar biblioteca de logging condicional (ex: apenas em desenvolvimento)
- Implementar sistema de logging estruturado para produção

**Prioridade:** Média - Corrigir em 2 semanas

---

## 2. Configuração Incorreta de Segurança

### VULN-004: CORS Muito Permissivo [CRÍTICA]

**Severidade:** Crítica  
**CVSS Score:** 8.6 (Alto)

**Descrição:**
Todas as funções Supabase Edge Functions têm CORS configurado como `Access-Control-Allow-Origin: '*'`, permitindo requisições de qualquer origem.

**Evidência:**
- `supabase/functions/get-stock-quote/index.ts` linha 5
- `supabase/functions/assistente-geral/index.ts` linha 6
- `supabase/functions/parse-bank-statement/index.ts` linha 4

**Impacto:**
- Qualquer site pode fazer requisições para as APIs
- Facilita ataques CSRF
- Permite que sites maliciosos consumam recursos da API

**Recomendação:**
- Restringir CORS para domínios específicos: `'Access-Control-Allow-Origin': 'https://seudominio.com'`
- Usar lista de origens permitidas baseada em variável de ambiente
- Implementar validação de origem no servidor

**Prioridade:** Crítica - Corrigir imediatamente

---

### VULN-005: Falta de Headers de Segurança HTTP [ALTA]

**Severidade:** Alta  
**CVSS Score:** 7.5 (Alto)

**Descrição:**
O arquivo `index.html` não possui headers de segurança como Content-Security-Policy, X-Frame-Options, X-Content-Type-Options, etc.

**Evidência:**
- `index.html` não contém meta tags de segurança
- Nenhum header HTTP de segurança configurado

**Impacto:**
- Vulnerável a ataques de clickjacking (X-Frame-Options)
- Vulnerável a XSS (sem CSP)
- Vulnerável a MIME type sniffing (sem X-Content-Type-Options)

**Recomendação:**
Adicionar ao `index.html` ou configurar no servidor:
```html
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.gpteng.co; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;">
<meta http-equiv="X-Frame-Options" content="DENY">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
```

**Prioridade:** Alta - Corrigir em 1 semana

---

## 3. Injeção (XSS)

### VULN-006: Uso de dangerouslySetInnerHTML [ALTA]

**Severidade:** Alta  
**CVSS Score:** 7.8 (Alto)

**Descrição:**
O código usa `dangerouslySetInnerHTML` em dois locais, potencialmente permitindo XSS se o conteúdo não for sanitizado adequadamente.

**Evidência:**
- `src/components/auth/TwoFactorSetup.tsx` linha 201: Renderiza QR code SVG
- `src/components/ui/chart.tsx` linha 79: Renderiza estilos CSS dinâmicos

**Impacto:**
- Se o QR code SVG vier de fonte não confiável, pode conter XSS
- Estilos CSS podem conter JavaScript se não sanitizados

**Recomendação:**
- Validar e sanitizar o conteúdo SVG antes de renderizar
- Usar biblioteca de sanitização HTML (ex: DOMPurify)
- Considerar alternativas mais seguras para renderização de SVG

**Prioridade:** Alta - Corrigir em 1 semana

---

### VULN-007: Validação de Entrada Inconsistente [MÉDIA]

**Severidade:** Média  
**CVSS Score:** 5.5 (Médio)

**Descrição:**
A validação de senha é inconsistente entre diferentes fluxos da aplicação.

**Evidência:**
- `src/lib/validators.ts` linha 69: Signup exige mínimo de 8 caracteres
- `src/pages/LandingResetPassword.tsx` linha 34: Reset password aceita apenas 6 caracteres

**Impacto:**
- Senhas fracas podem ser definidas no reset de senha
- Inconsistência pode confundir usuários
- Reduz segurança geral da aplicação

**Recomendação:**
- Padronizar validação de senha em todos os fluxos
- Usar o mesmo schema (`passwordSchema`) em reset password
- Garantir que todas as senhas atendam aos mesmos requisitos

**Prioridade:** Média - Corrigir em 2 semanas

---

## 4. Controle de Acesso Quebrado

### VULN-008: Rate Limiting Apenas Client-Side [CRÍTICA]

**Severidade:** Crítica  
**CVSS Score:** 8.9 (Alto)

**Descrição:**
O rate limiting é implementado apenas no cliente (`src/hooks/useRateLimit.tsx`), usando armazenamento em memória que pode ser facilmente burlado.

**Evidência:**
- `src/hooks/useRateLimit.tsx`: Rate limiting em Map em memória
- Nenhum rate limiting server-side nas funções Supabase

**Impacto:**
- Atacantes podem ignorar rate limiting modificando o código cliente
- APIs podem ser sobrecarregadas com requisições
- Facilita ataques de brute force e DoS

**Recomendação:**
- Implementar rate limiting server-side nas Edge Functions
- Usar Redis ou similar para rate limiting distribuído
- Configurar rate limiting no nível do Supabase (se disponível)
- Manter rate limiting client-side apenas como UX, não como segurança

**Prioridade:** Crítica - Corrigir imediatamente

---

### VULN-009: Enumeração de Usuários no Signup [MÉDIA]

**Severidade:** Média  
**CVSS Score:** 5.2 (Médio)

**Descrição:**
Mensagens de erro no signup podem permitir que atacantes descubram se um email está cadastrado no sistema.

**Evidência:**
- `src/pages/LandingSignup.tsx` linha 76: Mensagem específica "Este email já está cadastrado"
- Login já usa mensagem genérica (linha 64), mas signup não

**Impacto:**
- Atacantes podem enumerar emails válidos através do signup
- Facilita ataques de phishing direcionados
- Viola boas práticas de segurança

**Recomendação:**
- Usar mensagem genérica no signup também: "Não foi possível criar a conta. Verifique os dados e tente novamente."
- Não diferenciar entre "email já existe" e outros erros
- Implementar delay exponencial após tentativas falhas

**Prioridade:** Média - Corrigir em 2 semanas

---

## 5. Falhas de Autenticação

### VULN-010: Falta de Proteção Explícita Contra Brute Force [ALTA]

**Severidade:** Alta  
**CVSS Score:** 7.0 (Alto)

**Descrição:**
Não há proteção explícita contra ataques de brute force no frontend, além do rate limiting client-side que pode ser burlado.

**Evidência:**
- `src/pages/LandingLogin.tsx`: Não há delay após tentativas falhas
- Não há bloqueio de conta após múltiplas tentativas

**Impacto:**
- Atacantes podem tentar múltiplas senhas rapidamente
- Contas podem ser comprometidas através de força bruta

**Recomendação:**
- Implementar CAPTCHA após 3 tentativas falhas
- Adicionar delay exponencial entre tentativas
- Implementar bloqueio temporário de conta no backend
- Usar rate limiting server-side robusto

**Prioridade:** Alta - Corrigir em 1 semana

---

## 6. APIs Inseguras

### VULN-011: Falta de Validação de CSRF Tokens [MÉDIA]

**Severidade:** Média  
**CVSS Score:** 6.1 (Médio)

**Descrição:**
Não há validação de tokens CSRF nas requisições para as APIs.

**Evidência:**
- Funções Supabase não verificam tokens CSRF
- Requisições podem ser feitas de origens não autorizadas (agravado pelo CORS permissivo)

**Impacto:**
- Vulnerável a ataques CSRF
- Ações podem ser executadas sem consentimento do usuário

**Recomendação:**
- Implementar tokens CSRF para ações críticas
- Validar origem das requisições
- Usar SameSite cookies (quando aplicável)
- Considerar double-submit cookie pattern

**Prioridade:** Média - Corrigir em 2 semanas

---

### VULN-012: Tratamento de Erros Expõe Informações [BAIXA]

**Severidade:** Baixa  
**CVSS Score:** 3.5 (Baixo)

**Descrição:**
Alguns tratamentos de erro podem expor informações internas do sistema.

**Evidência:**
- `supabase/functions/get-stock-quote/index.ts`: Mensagens de erro podem revelar estrutura interna
- Stack traces podem ser expostos em desenvolvimento

**Impacto:**
- Informações sobre estrutura do sistema podem ser reveladas
- Facilita reconhecimento para atacantes

**Recomendação:**
- Usar mensagens de erro genéricas em produção
- Não expor stack traces para usuários finais
- Logar erros detalhados apenas no servidor

**Prioridade:** Baixa - Corrigir em 1 mês

---

## 7. Armazenamento Inseguro

### VULN-013: Preferências em localStorage [BAIXA]

**Severidade:** Baixa  
**CVSS Score:** 4.2 (Baixo)

**Descrição:**
Preferências do usuário são armazenadas em localStorage, que pode conter dados sensíveis.

**Evidência:**
- `src/hooks/useUserPreferences.tsx`: Armazena preferências em localStorage

**Impacto:**
- Se localStorage for comprometido (XSS), dados podem ser acessados
- Dados persistem mesmo após logout

**Recomendação:**
- Limpar localStorage ao fazer logout
- Considerar armazenar apenas no servidor
- Validar dados ao carregar do localStorage

**Prioridade:** Baixa - Corrigir em 1 mês

---

## 8. Componentes com Vulnerabilidades

### VULN-014: Dependências Atualizadas [BAIXA]

**Severidade:** Baixa  
**CVSS Score:** 2.0 (Baixo)

**Descrição:**
`npm audit` não encontrou vulnerabilidades conhecidas, mas algumas dependências podem estar desatualizadas.

**Evidência:**
- `npm audit` executado: 0 vulnerabilidades encontradas
- Algumas dependências podem ter versões mais recentes disponíveis

**Impacto:**
- Versões antigas podem ter vulnerabilidades não detectadas
- Falta de recursos de segurança mais recentes

**Recomendação:**
- Manter dependências atualizadas regularmente
- Usar `npm outdated` para verificar atualizações
- Implementar dependabot ou similar para atualizações automáticas

**Prioridade:** Baixa - Manutenção contínua

---

## 9. Validação de Entrada

### VULN-015: Validação de Symbol em Stock Quote [MÉDIA]

**Severidade:** Média  
**CVSS Score:** 5.8 (Médio)

**Descrição:**
A função `get-stock-quote` valida apenas presença do símbolo, mas não valida formato ou caracteres permitidos.

**Evidência:**
- `supabase/functions/get-stock-quote/index.ts` linha 62: Apenas verifica `if (!symbol)`
- Não valida formato do símbolo antes de usar em URL

**Impacto:**
- Possível injeção de parâmetros na URL da API externa
- Caracteres especiais podem causar comportamento inesperado

**Recomendação:**
- Validar formato do símbolo (ex: apenas letras e números, máximo X caracteres)
- Sanitizar entrada antes de usar em URL
- Usar whitelist de caracteres permitidos

**Prioridade:** Média - Corrigir em 2 semanas

---

## Resumo de Vulnerabilidades por Severidade

### Críticas (3)
1. VULN-001: Chave Supabase Exposta
2. VULN-004: CORS Muito Permissivo
3. VULN-008: Rate Limiting Apenas Client-Side

### Altas (5)
4. VULN-002: Dados Sensíveis em localStorage
5. VULN-005: Falta de Headers de Segurança
6. VULN-006: Uso de dangerouslySetInnerHTML
7. VULN-010: Falta de Proteção Brute Force
8. VULN-011: Falta de CSRF Protection (parcialmente alta)

### Médias (4)
9. VULN-003: Informações em Logs
10. VULN-007: Validação Inconsistente
11. VULN-009: Enumeração de Usuários
12. VULN-015: Validação de Symbol

### Baixas (3)
13. VULN-012: Tratamento de Erros
14. VULN-013: Preferências em localStorage
15. VULN-014: Dependências

---

## Recomendações Prioritárias

### Imediato (Esta Semana)
1. ✅ Restringir CORS para domínios específicos
2. ✅ Mover chave Supabase para variáveis de ambiente
3. ✅ Implementar rate limiting server-side

### Curto Prazo (1-2 Semanas)
4. ✅ Adicionar headers de segurança HTTP
5. ✅ Sanitizar uso de dangerouslySetInnerHTML
6. ✅ Padronizar validação de senha
7. ✅ Implementar proteção contra brute force

### Médio Prazo (1 Mês)
8. ✅ Implementar proteção CSRF
9. ✅ Melhorar tratamento de erros
10. ✅ Limpar localStorage ao logout

---

## Checklist de Segurança para Futuras Implementações

- [ ] Sempre validar inputs no servidor
- [ ] Nunca confiar apenas em validação client-side
- [ ] Implementar rate limiting server-side
- [ ] Usar variáveis de ambiente para secrets
- [ ] Configurar CORS restritivo
- [ ] Adicionar headers de segurança
- [ ] Sanitizar todos os inputs antes de renderizar
- [ ] Implementar proteção CSRF para ações críticas
- [ ] Usar mensagens de erro genéricas
- [ ] Limpar dados sensíveis do localStorage ao logout
- [ ] Manter dependências atualizadas
- [ ] Implementar logging seguro (sem dados sensíveis)
- [ ] Testar segurança em cada nova feature

---

## Conclusão

A aplicação MoMoney apresenta várias vulnerabilidades de segurança que precisam ser corrigidas, especialmente relacionadas a configuração de segurança (CORS, headers), exposição de dados sensíveis e controle de acesso. As vulnerabilidades críticas devem ser corrigidas imediatamente, enquanto as demais podem ser tratadas em um cronograma estruturado.

**Recomendação Geral:** Implementar um processo de segurança contínua (DevSecOps) para prevenir vulnerabilidades futuras e garantir que novas features sejam desenvolvidas com segurança em mente desde o início.

---

**Fim do Relatório**
